---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease

metadata:
  name: flux-operator
  namespace: flux-system

spec:
  interval: 1h

  chartRef:
    kind: OCIRepository
    name: flux-operator
    namespace: flux-system

  releaseName: flux-operator
  targetNamespace: flux-system


---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease

metadata:
  name: flux-instance
  namespace: flux-system

spec:
  interval: 1h

  chartRef:
    kind: OCIRepository
    name: flux-instance
    namespace: flux-system

  releaseName: flux-instance
  targetNamespace: flux-system

  values:
    instance:
      components:
        - source-controller
        - kustomize-controller
        - helm-controller
        - notification-controller
        - image-reflector-controller
        - image-automation-controller
      distribution:
        # renovate: datasource=github-releases depName=flux2 packageName=fluxcd/flux2
        version: "v2.6.4"
        registry: "ghcr.io/fluxcd"
      sync:
        kind: "GitRepository"
        url: "https://github.com/masood09/infra-flux.git"
        path: "clusters/homelab-staging"
        ref: "refs/heads/main"
        provider: "generic"
        pullSecret: "github-auth"
    serviceMonitor:
      create: true
    kustomize:
      patches:
        - target:
            kind: Deployment
            name: "(kustomize-controller|helm-controller)"
            patch: |
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --concurrent=10
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --requeue-dependency=10s
